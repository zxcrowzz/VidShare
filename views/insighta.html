<!DOCTYPE html>
<link rel="icon" type="image/png" href="/public/DALL·E 2024-11-19 21.48.04 - A flat 2D logo for a platform named 'VidShare'. The logo features a minimalist design with a simple play button icon integrated into the text. The wor.png">
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VidShare - Home</title>
  <link rel="stylesheet" href="/public/insight.css">
</head>
<body>
 <div id="profile-menu" class="menu hidden">
  <ul>
    <li id="settings-option">Settings</li>
    <li id="profile-option">Profile</li>
    <li id="edit-post-option">Edit Post</li>
  </ul>
    </div>


<div id="profile-settings-modal" class="modal hidden">
 <form id="profile-form">
  <input type="file" id="profile-img-upload" name="profileImgUpload" />
  <button type="submit">Save Changes</button>
</form>

</div>

<!-- Edit Post Modal -->
<div id="edit-post-modal" class="modal hidden">
  <div class="modal-content">
    <h2>Edit Posts</h2>
    <div id="user-posts-container">
      <!-- Posts will be dynamically rendered here -->
    </div>
    <button id="close-edit-post-modal">Close</button>
  </div>
</div>


  
  <header>
    
    <img alt="logo" src="/public/DALL·E 2024-11-19 21.48.04 - A flat 2D logo for a platform named 'VidShare'. The logo features a minimalist design with a simple play button icon integrated into the text. The wor.png" id = "logoPic">
    <div class="logo" id = "logoz">VidShare</div>
    <div class="search-bar">
      <label id = "searchvid" for="searchInput" class="sr-only">Search videos</label> <!-- Accessible label -->
      <input type="text" id="searchInput" placeholder="Search videos..." title="Search for videos" aria-label="Search videos">
      <button id = "activate" title="Search">Search</button>
    </div>
    <div class="profile">
      <img src="/public/DALL·E 2024-11-19 21.48.04 - A flat 2D logo for a platform named 'VidShare'. The logo features a minimalist design with a simple play button icon integrated into the text. The wor.png" alt="Profile Picture" class="profile-img">
    </div>
    <!-- Add Up Button -->
    <button id="uploadBtn" class="up-btn" title="Upload Video">Upload</button>
  </header>

  <main>
    <section class="video-grid" id="videoContainer">
      <!-- Video cards dynamically loaded here -->
    </section>
  </main>

  <!-- Video Upload Modal -->
  <div id="uploadModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Upload Your Video</h2>
      <form id="uploadForm" action="/upload-video" method="POST" enctype="multipart/form-data">
        <!-- Video file input with label and title/placeholder -->
        <label for="video" id="videoLabel">Choose a video</label>
        <input type="file" id="video" name="video" accept="video/*" required title="Choose a video file to upload">
      
        <!-- Title input with label and placeholder -->
        <label for="title" id="titleLabel">Video Title</label>
        <input type="text" id="title" name="title" placeholder="Enter video title" required title="Enter a title for the video">
      
        <!-- Submit button -->
        <button type="submit">Upload Video</button>
      </form>
      
      
      <p id="upload-status"></p>
    </div>


  <footer>
    <p>&copy; 2024 VidShare. All Rights Reserved.</p>
  </footer>

 <!-- JS for handling video upload -->


 <script>


document.getElementById('profile-img-upload').addEventListener('change', async function () {
  const file = this.files[0];

  if (file) {
    // Create FormData and append the file
    const formData = new FormData();
    formData.append('profilePic', file);

    // Send the file to the server
    try {
      const response = await fetch('/api/upload-profile-picture', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();

      if (response.ok) {
        alert('Profile picture uploaded successfully!');
      } else {
        console.error('Error uploading picture:', result.error);
      }
    } catch (error) {
      console.error('Failed to upload profile picture:', error);
    }
  }
});
   

 
   
document.addEventListener('DOMContentLoaded', () => {



  
  // --- GLOBAL VARIABLES ---
  const videoContainer = document.getElementById('videoContainer');
  let currentPage = 1;
  const videosPerPage = 12;
  let isLoading = false;

  const modal = document.getElementById('uploadModal');
  const uploadBtn = document.getElementById('uploadBtn');
  const closeModal = document.getElementsByClassName('close')[0];

  const profileImg = document.querySelector('.profile-img');
  const profileMenu = document.getElementById('profile-menu');
  const profileSettingsModal = document.getElementById('profile-settings-modal');
  const editPostModal = document.getElementById('edit-post-modal');

  // --- MODAL FUNCTIONALITY ---
  uploadBtn.onclick = () => {
    modal.style.display = 'block';
  };

  closeModal.onclick = () => {
    modal.style.display = 'none';
  };

  window.onclick = (event) => {
    if (event.target === modal) {
      modal.style.display = 'none';
    }
  };

    async function loadProfilePicture() {
  try {
    const response = await fetch('/api/profile-picture');
    const imgElement = document.querySelector('.profile-img');
  
    
    // Check if the image element exists in the DOM
    if (!imgElement) {
      console.error('Profile image element not found!');
      return;
    }

    if (response.ok) {
      const blob = await response.blob(); // Convert the image data into a blob
      imgElement.src = URL.createObjectURL(blob);
      
    } else if (response.status === 404) {
      console.error('Profile picture not found. Using default image.');
     
    }
  } catch (error) {
    console.error('Error loading profile picture:', error);
  }
}



  // --- PROFILE MENU TOGGLE ---
  profileImg.addEventListener('click', () => {
    profileMenu.classList.toggle('hidden');
    profileMenu.style.display = profileMenu.classList.contains('hidden') ? 'none' : 'block';
  });

  document.addEventListener('click', (event) => {
    if (!profileMenu.contains(event.target) && !profileImg.contains(event.target)) {
      profileMenu.classList.add('hidden');
      profileMenu.style.display = 'none';
    }
  });

  // --- PROFILE SETTINGS FUNCTIONALITY ---
  document.getElementById('settings-option').addEventListener('click', () => {
    profileSettingsModal.classList.remove('hidden');
    profileMenu.classList.add('hidden');
    profileSettingsModal.style.display = 'block';
  });

  document.getElementById('profile-settings-modal').addEventListener('submit', (e) => {
    e.preventDefault();
    const name = document.getElementById('profile-name').value;
    const email = document.getElementById('profile-email').value;
    const profileImgUpload = document.getElementById('profile-img-upload').files[0];

    console.log('Save Changes:', { name, email, profileImgUpload });
    profileSettingsModal.classList.add('hidden');
  });

  // --- EDIT POST FUNCTIONALITY ---
  document.getElementById('edit-post-option').addEventListener('click', loadEditPostModal);

  function loadEditPostModal() {
    editPostModal.classList.remove('hidden');
    profileMenu.classList.add('hidden');
    editPostModal.style.display = 'block';

    // Fetch user posts
    fetch('/get-user-posts') // Update to your actual endpoint
      .then((response) => response.json())
      .then((posts) => {
        const postContainer = document.getElementById('user-posts-container');
        postContainer.innerHTML = '';

        if (posts.length) {
          posts.forEach((post) => {
            const postItem = document.createElement('div');
            postItem.classList.add('post-item');
            postItem.setAttribute('data-id', post._id);

            postItem.innerHTML = `
              <textarea class="post-content">${post.content}</textarea>
              <button class="save-post" data-id="${post._id}">Save</button>
              <button class="delete-post" data-id="${post._id}">Delete</button>
            `;

            postContainer.appendChild(postItem);
          });
        } else {
          postContainer.innerHTML = '<p>No posts to edit.</p>';
        }
      })
      .catch((error) => console.error('Error loading posts:', error));
  }

  document.getElementById('user-posts-container').addEventListener('click', (event) => {
    const target = event.target;

    if (target.classList.contains('save-post')) {
      const postId = target.dataset.id;
      const content = target.parentElement.querySelector('.post-content').value;

      fetch(`/edit-post/${postId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      })
        .then((response) => response.json())
        .then((data) => {
          alert(data.success ? 'Post updated successfully!' : 'Failed to update post.');
        })
        .catch((error) => console.error('Error updating post:', error));
    }

    if (target.classList.contains('delete-post')) {
      const postId = target.dataset.id;

      if (confirm('Are you sure you want to delete this post?')) {
        fetch(`/delete-post/${postId}`, { method: 'DELETE' })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              target.parentElement.remove();
              alert('Post deleted successfully.');
            } else {
              alert('Failed to delete post.');
            }
          })
          .catch((error) => console.error('Error deleting post:', error));
      }
    }
  });

 

  // --- VIDEO UPLOAD FUNCTIONALITY ---
  const form = document.getElementById('uploadForm');
  form.addEventListener('submit', async (event) => {
    event.preventDefault();
    const formData = new FormData(form);

    try {
      const response = await fetch('/upload-video', {
        method: 'POST',
        body: formData,
      });

      const data = await response.json();
      if (data.success) {
        appendVideoToContainer(data.video);
      } else {
        alert(data.message);
      }
    } catch (error) {
      console.error('Error uploading video:', error);
      alert('An error occurred while uploading the video.');
    }
  });

  // --- VIDEO DISPLAY FUNCTIONALITY ---
  async function loadVideos() {
    if (isLoading) return;

    isLoading = true;
    try {
      const response = await fetch(`/get-videos?page=${currentPage}&limit=${videosPerPage}`);
      const data = await response.json();

      if (data.videos && data.videos.length) {
        displayVideos(data.videos);
        currentPage++;
      }
    } catch (error) {
      console.error('Error loading videos:', error);
    } finally {
      isLoading = false;
    }
  }

function displayVideos(videos) {
  videos.forEach(video => appendVideoToContainer(video));
}
  function appendVideoToContainer(video) {
    const videoCard = document.createElement('div');
    videoCard.classList.add('video-card-container');

    videoCard.innerHTML = `
      <div class="video-title">${video.title || 'Untitled Video'}</div>
      <div class="video-description">${video.description || 'No description available.'}</div>
      <video crossOrigin="anonymous" controls width="300" src="${video.videoUrl}" class="video-card"></video>
      <div class="nameVideo">${video.user?.name || 'Anonymous User'}</div>
    `;

    videoContainer.appendChild(videoCard);

    const videocard = document.querySelector(".video-card");


    const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

// Load the video
videocard.addEventListener('loadeddata', function () {
  // Set the canvas size to match the video
  canvas.width = videocard.videoWidth;
  canvas.height = videocard.videoHeight;
  
  // Seek to a time (e.g., 1 second) for the thumbnail
 videocard.currentTime = 1;
});

// When the video time is updated, capture the frame and update the poster
videocard.addEventListener('seeked', function () {
  ctx.drawImage(videocard, 0, 0, canvas.width, canvas.height);
  videocard.poster = canvas.toDataURL(); // Set the dynamic thumbnail
});
  }

  // --- SEARCH FUNCTIONALITY ---
  const activate = document.getElementById('activate');
  activate.addEventListener('click', searchVideos);

 function searchVideos() {
  const searchTitle = document.getElementById('searchInput').value.trim();

  if (searchTitle) {
    fetch(`/search-videos?title=${encodeURIComponent(searchTitle)}`)
      .then((response) => response.json())
      .then((data) => {
        videoContainer.innerHTML = ''; // Clear the container
        if (data.videos && data.videos.length) {
          displayVideos(data.videos);
        } else {
          console.log('No matching videos found.');
          videoContainer.innerHTML = '<p>No videos found.</p>';
        }
      })
      .catch((error) => console.error('Error searching videos:', error));
  }
}

  // --- INITIAL VIDEO LOAD ---
  loadVideos();
  loadProfilePicture()
  window.addEventListener('scroll', () => {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500 && !isLoading) {
      loadVideos();
    }
  });
});

  </script>
  
  
</body>
</html>
